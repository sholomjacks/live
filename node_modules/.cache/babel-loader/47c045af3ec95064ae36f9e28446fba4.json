{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar ramda_1 = require(\"ramda\");\n\nvar pure_1 = require(\"./pure\");\n\nvar redis_1 = require(\"./redis\");\n\nvar nested_get = function (path, client, _a) {\n  var include_index_keys = _a.include_index_keys,\n      max_layers = _a.max_layers;\n  return __awaiter(void 0, void 0, void 0, function () {\n    var key, entry_point_node_type, branch_keys, leaf_keys;\n    return __generator(this, function (_b) {\n      switch (_b.label) {\n        case 0:\n          key = pure_1.path_to_key(path);\n          return [4\n          /*yield*/\n          , redis_1.redis_commands([['type', key]], client)];\n\n        case 1:\n          entry_point_node_type = _b.sent()[0];\n          branch_keys = entry_point_node_type === 'hash' ? [key] : [];\n          leaf_keys = entry_point_node_type === 'hash' ? [] : [key];\n          return [2\n          /*return*/\n          , get_pairs(branch_keys, leaf_keys, {}, client, {\n            include_index_keys: include_index_keys,\n            max_layers: max_layers\n          }, 0)];\n      }\n    });\n  });\n}; // current_layer = 1\n// \"\" => {people: 'branch', animals: 'branch'}\n// // current_layer = 2\n// \"people\" => {0: 'branch', 1: 'branch'}\n// \"animals\" => {0: 'branch', 1: 'branch', 2: 'branch'}\n// // current_layer = 3\n// 'people.0' => {name: 'leaf', age: 'leaf'}\n// 'people.1' => {name: 'leaf', settings: 'branch'}\n// 'animals.0'\n// 'animals.1'\n// 'animals.2'\n// // current_layer = 4\n// 'people.0.name'\n\n\nvar get_pairs = function (branch_keys, leaf_keys, output, client, _a, current_layer) {\n  var include_index_keys = _a.include_index_keys,\n      max_layers = _a.max_layers;\n  return __awaiter(void 0, void 0, void 0, function () {\n    var _b, leaf_results, branch_results, next_keys, next_branch_keys, next_leaf_keys, new_branch_output, new_leaf_output, new_output;\n\n    return __generator(this, function (_c) {\n      switch (_c.label) {\n        case 0:\n          if (current_layer === max_layers) return [2\n          /*return*/\n          , output];\n          return [4\n          /*yield*/\n          , Promise.all([leaf_keys.length > 0 ? redis_1.redis_commands([__spreadArrays(['mget'], leaf_keys)], client).then(ramda_1.unnest) : Promise.resolve([]), branch_keys.length > 0 ? redis_1.redis_commands(branch_keys.map(function (bk) {\n            return ['hgetall', bk];\n          }), client) : Promise.resolve([])])];\n\n        case 1:\n          _b = _c.sent(), leaf_results = _b[0], branch_results = _b[1];\n\n          next_keys = function (key_type) {\n            return ramda_1.compose(ramda_1.unnest, ramda_1.addIndex(ramda_1.map)(function (branch_key, i) {\n              var branch_indices = ramda_1.filter(ramda_1.equals(key_type), branch_results[i]);\n              return ramda_1.keys(branch_indices).map(pure_1.concat_with_dot(branch_key));\n            }))(branch_keys);\n          };\n\n          next_branch_keys = next_keys('branch');\n          next_leaf_keys = next_keys('leaf');\n          new_branch_output = ramda_1.zipObj(branch_keys, branch_results);\n          new_leaf_output = ramda_1.zipObj(leaf_keys, leaf_results);\n          new_output = include_index_keys ? __assign(__assign(__assign({}, output), new_leaf_output), new_branch_output) : __assign(__assign({}, output), new_leaf_output);\n          if (ramda_1.isEmpty(next_branch_keys) && ramda_1.isEmpty(next_leaf_keys)) return [2\n          /*return*/\n          , new_output];\n          return [2\n          /*return*/\n          , get_pairs(next_branch_keys, next_leaf_keys, new_output, client, {\n            include_index_keys: include_index_keys,\n            max_layers: max_layers\n          }, current_layer + 1)];\n      }\n    });\n  });\n};\n\nexports.user_get = function (path, client) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var pairs, json_obj, output;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , nested_get(path, client, {\n            include_index_keys: false,\n            max_layers: -1\n          })];\n\n        case 1:\n          pairs = _a.sent();\n          json_obj = ramda_1.compose(pure_1.pairs_to_json)(pairs);\n          output = ramda_1.equals(path, [\"\"]) ? json_obj : pure_1.strict_path_or(undefined, path, json_obj);\n          return [2\n          /*return*/\n          , output];\n      }\n    });\n  });\n};\n\nexports.user_delete = function (path, client, quiet) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var pairs, todo, one_layer_up, last_el, key_to_update;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , nested_get(path, client, {\n            include_index_keys: true,\n            max_layers: -1\n          })];\n\n        case 1:\n          pairs = _a.sent();\n          todo = [__spreadArrays(['del'], ramda_1.keys(pairs))];\n          if (!!ramda_1.equals(path, [\"\"])) return [3\n          /*break*/\n          , 3];\n          return [4\n          /*yield*/\n          , nested_get(ramda_1.slice(0, -1)(path), client, {\n            include_index_keys: true,\n            max_layers: 1\n          }) // remove the one key from the index\n          ];\n\n        case 2:\n          one_layer_up = _a.sent(); // remove the one key from the index\n\n          if (!ramda_1.isNil(one_layer_up)) {\n            last_el = ramda_1.last(path);\n            key_to_update = pure_1.path_to_key(ramda_1.slice(0, -1)(path));\n            todo.push(['hdel', key_to_update, last_el]);\n          }\n\n          _a.label = 3;\n\n        case 3:\n          return [4\n          /*yield*/\n          , redis_1.redis_commands(todo, client)];\n\n        case 4:\n          _a.sent();\n\n          if (quiet) return [2\n          /*return*/\n          , pairs];\n          client.publish('changes', pure_1.stringify({\n            old: pairs,\n            new: ramda_1.reduce(function (acc, val) {\n              var _a;\n\n              return __assign(__assign({}, acc), (_a = {}, _a[val] = null, _a));\n            }, {}, ramda_1.keys(pairs))\n          }));\n          return [2\n          /*return*/\n          , pairs];\n      }\n    });\n  });\n};\n\nexports.user_set = function (path, given_child_pairs, client) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var old_pairs, add_children_command, add_to_index_commands;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , exports.user_delete(path, client, true)];\n\n        case 1:\n          old_pairs = _a.sent();\n          add_children_command = ['mset', given_child_pairs];\n          add_to_index_commands = pure_1.get_required_indexes(ramda_1.keys(given_child_pairs));\n          return [4\n          /*yield*/\n          , redis_1.redis_commands(__spreadArrays([add_children_command], add_to_index_commands), client)];\n\n        case 2:\n          _a.sent();\n\n          client.publish('changes', pure_1.stringify({\n            old: old_pairs,\n            new: given_child_pairs\n          }));\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n};","map":{"version":3,"sources":["C:/Users/gamem/codecademy/node_modules/redibase/build/user.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","__generator","body","_","label","sent","trys","ops","f","y","g","verb","Symbol","iterator","v","op","TypeError","pop","push","__spreadArrays","il","r","Array","k","a","j","jl","defineProperty","exports","ramda_1","require","pure_1","redis_1","nested_get","path","client","_a","include_index_keys","max_layers","key","entry_point_node_type","branch_keys","leaf_keys","_b","path_to_key","redis_commands","get_pairs","output","current_layer","leaf_results","branch_results","next_keys","next_branch_keys","next_leaf_keys","new_branch_output","new_leaf_output","new_output","_c","all","unnest","map","bk","key_type","compose","addIndex","branch_key","branch_indices","filter","equals","keys","concat_with_dot","zipObj","isEmpty","user_get","pairs","json_obj","pairs_to_json","strict_path_or","undefined","user_delete","quiet","todo","one_layer_up","last_el","key_to_update","slice","isNil","last","publish","stringify","old","new","reduce","acc","val","user_set","given_child_pairs","old_pairs","add_children_command","add_to_index_commands","get_required_indexes"],"mappings":"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","sourcesContent":["\"use strict\";\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nvar __generator = (this && this.__generator) || function (thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar ramda_1 = require(\"ramda\");\r\nvar pure_1 = require(\"./pure\");\r\nvar redis_1 = require(\"./redis\");\r\nvar nested_get = function (path, client, _a) {\r\n    var include_index_keys = _a.include_index_keys, max_layers = _a.max_layers;\r\n    return __awaiter(void 0, void 0, void 0, function () {\r\n        var key, entry_point_node_type, branch_keys, leaf_keys;\r\n        return __generator(this, function (_b) {\r\n            switch (_b.label) {\r\n                case 0:\r\n                    key = pure_1.path_to_key(path);\r\n                    return [4 /*yield*/, redis_1.redis_commands([['type', key]], client)];\r\n                case 1:\r\n                    entry_point_node_type = (_b.sent())[0];\r\n                    branch_keys = entry_point_node_type === 'hash' ? [key] : [];\r\n                    leaf_keys = entry_point_node_type === 'hash' ? [] : [key];\r\n                    return [2 /*return*/, get_pairs(branch_keys, leaf_keys, {}, client, { include_index_keys: include_index_keys, max_layers: max_layers }, 0)];\r\n            }\r\n        });\r\n    });\r\n};\r\n// current_layer = 1\r\n// \"\" => {people: 'branch', animals: 'branch'}\r\n// // current_layer = 2\r\n// \"people\" => {0: 'branch', 1: 'branch'}\r\n// \"animals\" => {0: 'branch', 1: 'branch', 2: 'branch'}\r\n// // current_layer = 3\r\n// 'people.0' => {name: 'leaf', age: 'leaf'}\r\n// 'people.1' => {name: 'leaf', settings: 'branch'}\r\n// 'animals.0'\r\n// 'animals.1'\r\n// 'animals.2'\r\n// // current_layer = 4\r\n// 'people.0.name'\r\nvar get_pairs = function (branch_keys, leaf_keys, output, client, _a, current_layer) {\r\n    var include_index_keys = _a.include_index_keys, max_layers = _a.max_layers;\r\n    return __awaiter(void 0, void 0, void 0, function () {\r\n        var _b, leaf_results, branch_results, next_keys, next_branch_keys, next_leaf_keys, new_branch_output, new_leaf_output, new_output;\r\n        return __generator(this, function (_c) {\r\n            switch (_c.label) {\r\n                case 0:\r\n                    if (current_layer === max_layers)\r\n                        return [2 /*return*/, output];\r\n                    return [4 /*yield*/, Promise.all([\r\n                            leaf_keys.length > 0 ? redis_1.redis_commands([__spreadArrays(['mget'], leaf_keys)], client).then(ramda_1.unnest) : Promise.resolve([]),\r\n                            branch_keys.length > 0 ? redis_1.redis_commands(branch_keys.map(function (bk) { return ['hgetall', bk]; }), client) : Promise.resolve([])\r\n                        ])];\r\n                case 1:\r\n                    _b = _c.sent(), leaf_results = _b[0], branch_results = _b[1];\r\n                    next_keys = function (key_type) { return ramda_1.compose(ramda_1.unnest, ramda_1.addIndex(ramda_1.map)(function (branch_key, i) {\r\n                        var branch_indices = ramda_1.filter(ramda_1.equals(key_type), branch_results[i]);\r\n                        return ramda_1.keys(branch_indices).map(pure_1.concat_with_dot(branch_key));\r\n                    }))(branch_keys); };\r\n                    next_branch_keys = next_keys('branch');\r\n                    next_leaf_keys = next_keys('leaf');\r\n                    new_branch_output = ramda_1.zipObj(branch_keys, branch_results);\r\n                    new_leaf_output = ramda_1.zipObj(leaf_keys, leaf_results);\r\n                    new_output = include_index_keys\r\n                        ? __assign(__assign(__assign({}, output), new_leaf_output), new_branch_output) : __assign(__assign({}, output), new_leaf_output);\r\n                    if (ramda_1.isEmpty(next_branch_keys) && ramda_1.isEmpty(next_leaf_keys))\r\n                        return [2 /*return*/, new_output];\r\n                    return [2 /*return*/, get_pairs(next_branch_keys, next_leaf_keys, new_output, client, { include_index_keys: include_index_keys, max_layers: max_layers }, current_layer + 1)];\r\n            }\r\n        });\r\n    });\r\n};\r\nexports.user_get = function (path, client) { return __awaiter(void 0, void 0, void 0, function () {\r\n    var pairs, json_obj, output;\r\n    return __generator(this, function (_a) {\r\n        switch (_a.label) {\r\n            case 0: return [4 /*yield*/, nested_get(path, client, { include_index_keys: false, max_layers: -1 })];\r\n            case 1:\r\n                pairs = _a.sent();\r\n                json_obj = ramda_1.compose(pure_1.pairs_to_json)(pairs);\r\n                output = ramda_1.equals(path, [\"\"]) ? json_obj : pure_1.strict_path_or(undefined, path, json_obj);\r\n                return [2 /*return*/, output];\r\n        }\r\n    });\r\n}); };\r\nexports.user_delete = function (path, client, quiet) { return __awaiter(void 0, void 0, void 0, function () {\r\n    var pairs, todo, one_layer_up, last_el, key_to_update;\r\n    return __generator(this, function (_a) {\r\n        switch (_a.label) {\r\n            case 0: return [4 /*yield*/, nested_get(path, client, { include_index_keys: true, max_layers: -1 })];\r\n            case 1:\r\n                pairs = _a.sent();\r\n                todo = [__spreadArrays(['del'], ramda_1.keys(pairs))];\r\n                if (!!ramda_1.equals(path, [\"\"])) return [3 /*break*/, 3];\r\n                return [4 /*yield*/, nested_get(ramda_1.slice(0, -1)(path), client, { include_index_keys: true, max_layers: 1 })\r\n                    // remove the one key from the index\r\n                ];\r\n            case 2:\r\n                one_layer_up = _a.sent();\r\n                // remove the one key from the index\r\n                if (!ramda_1.isNil(one_layer_up)) {\r\n                    last_el = ramda_1.last(path);\r\n                    key_to_update = pure_1.path_to_key(ramda_1.slice(0, -1)(path));\r\n                    todo.push(['hdel', key_to_update, last_el]);\r\n                }\r\n                _a.label = 3;\r\n            case 3: return [4 /*yield*/, redis_1.redis_commands(todo, client)];\r\n            case 4:\r\n                _a.sent();\r\n                if (quiet)\r\n                    return [2 /*return*/, pairs];\r\n                client.publish('changes', pure_1.stringify({ old: pairs, new: ramda_1.reduce(function (acc, val) {\r\n                        var _a;\r\n                        return (__assign(__assign({}, acc), (_a = {}, _a[val] = null, _a)));\r\n                    }, {}, ramda_1.keys(pairs)) }));\r\n                return [2 /*return*/, pairs];\r\n        }\r\n    });\r\n}); };\r\nexports.user_set = function (path, given_child_pairs, client) { return __awaiter(void 0, void 0, void 0, function () {\r\n    var old_pairs, add_children_command, add_to_index_commands;\r\n    return __generator(this, function (_a) {\r\n        switch (_a.label) {\r\n            case 0: return [4 /*yield*/, exports.user_delete(path, client, true)];\r\n            case 1:\r\n                old_pairs = _a.sent();\r\n                add_children_command = ['mset', given_child_pairs];\r\n                add_to_index_commands = pure_1.get_required_indexes(ramda_1.keys(given_child_pairs));\r\n                return [4 /*yield*/, redis_1.redis_commands(__spreadArrays([add_children_command], add_to_index_commands), client)];\r\n            case 2:\r\n                _a.sent();\r\n                client.publish('changes', pure_1.stringify({ old: old_pairs, new: given_child_pairs }));\r\n                return [2 /*return*/];\r\n        }\r\n    });\r\n}); };\r\n"]},"metadata":{},"sourceType":"script"}