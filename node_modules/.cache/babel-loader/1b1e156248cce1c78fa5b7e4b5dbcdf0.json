{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || function () {\n  __assign = Object.assign || function (t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n      s = arguments[i];\n\n      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n    }\n\n    return t;\n  };\n\n  return __assign.apply(this, arguments);\n};\n\nvar __spreadArrays = this && this.__spreadArrays || function () {\n  for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\n\n  for (var r = Array(s), k = 0, i = 0; i < il; i++) for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) r[k] = a[j];\n\n  return r;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar ramda_1 = require(\"ramda\");\n\nvar serialize = require('serialize-javascript');\n\nexports.is_array = function (el) {\n  return ramda_1.type(el) === 'Array';\n};\n\nexports.is_object = function (el) {\n  return ramda_1.type(el) === 'Object';\n};\n\nexports.is_array_or_object = function (el) {\n  return ramda_1.type(el) === 'Array' || ramda_1.type(el) === 'Object';\n};\n\nvar ensure_is_array = function (value) {\n  return exports.is_array(value) ? value : [value];\n};\n\nexports.is_numeric_string = ramda_1.test(/^0$|^[1-9][0-9]*$/);\n\nexports.path_to_key = function (path) {\n  return ramda_1.type(path) === \"Array\" ? path.join('.') : path;\n};\n\nexports.key_to_path = function (path) {\n  return ramda_1.type(path) === \"String\" ? ramda_1.compose(ramda_1.map(function (el) {\n    return exports.is_numeric_string(el) ? Number(el) : el;\n  }), ramda_1.split('.'))(path) : path;\n};\n\nexports.stringify = function (value) {\n  return serialize(value, {\n    ignoreFunction: true\n  });\n};\n\nexports.parse = function (serializedJavascript) {\n  return eval('(' + serializedJavascript + ')');\n};\n\nexports.concat_if_nonexistent = function (arr1, arr2) {\n  return ramda_1.uniq(__spreadArrays(arr1, arr2));\n};\n\nexports.concat_with_dot = ramda_1.curry(function (a, b) {\n  return ramda_1.compose(ramda_1.join('.'), ramda_1.reject(ramda_1.isEmpty))([a, b]);\n});\n\nvar json_to_path_list = function (val) {\n  if (exports.is_array(val)) {\n    var child_paths = ramda_1.unnest(val.map(function (child, i) {\n      return json_to_path_list(child).map(function (path) {\n        return __spreadArrays([i], path);\n      });\n    }));\n    return child_paths;\n  }\n\n  if (exports.is_object(val)) {\n    var child_paths = ramda_1.chain(function (key, i) {\n      return json_to_path_list(val[key]).map(function (path) {\n        return __spreadArrays([key], path);\n      });\n    })(ramda_1.keys(val));\n    return child_paths;\n  }\n\n  return [[]];\n};\n\nexports.who_cares = function (changes, subscriptions) {\n  return ramda_1.reduce(function (acc, val) {\n    var changed_key = val;\n    var new_pairs = changes.new[changed_key];\n    var old_pairs = changes.old[changed_key];\n    var relevant_subscription_keys = ramda_1.keys(subscriptions).filter(function (key) {\n      return ramda_1.startsWith(key)(changed_key);\n    });\n    return ramda_1.concat(relevant_subscription_keys.map(function (watched_key) {\n      var fns = ramda_1.values(subscriptions[watched_key]);\n      return {\n        watched_key: watched_key,\n        changed_key: changed_key,\n        new: new_pairs,\n        old: old_pairs,\n        fns: fns\n      };\n    }), acc);\n  }, [])(ramda_1.keys(__assign(__assign({}, changes.old), changes.new)));\n}; // like pathOr but doesnt return null when value is null and not undefined\n\n\nexports.strict_path_or = function (default_val, val_path, obj) {\n  if (val_path.length === 0) {\n    return obj;\n  }\n\n  if (ramda_1.hasPath(val_path, obj)) {\n    return ramda_1.path(val_path, obj);\n  } else {\n    return default_val;\n  }\n};\n\nexports.json_to_pairs = function (json) {\n  var path_list = json_to_path_list(json);\n  return ramda_1.reduce(function (acc, val) {\n    var _a;\n\n    var redis_key = exports.path_to_key(val);\n    var given_value = exports.strict_path_or(undefined, val, json);\n    var redis_value = exports.is_array_or_object(given_value) ? ramda_1.keys(given_value) : given_value;\n    return __assign(__assign({}, acc), (_a = {}, _a[redis_key] = redis_value, _a));\n  }, {})(path_list);\n};\n\nexports.pairs_to_json = function (pairs) {\n  var output = {};\n  var paths = ramda_1.compose(ramda_1.map(function (key) {\n    return {\n      path: exports.key_to_path(key),\n      val: pairs[key]\n    };\n  }), ramda_1.keys)(pairs);\n  paths.map(function (path_el) {\n    return output = ramda_1.assocPath(path_el.path, path_el.val, output);\n  });\n  return output;\n};\n\nexports.map_keys = ramda_1.curry(function (fn, obj) {\n  return ramda_1.fromPairs(ramda_1.map(ramda_1.adjust(0, fn), ramda_1.toPairs(obj)));\n});\n\nexports.delete_parent_indices = function (missing_paths, data) {\n  var output = ramda_1.reduce(function (acc, val) {\n    var _a;\n\n    var old_index = acc[exports.path_to_key(ramda_1.dropLast(1, val))];\n    if (ramda_1.isNil(old_index)) return acc;\n    var new_index = ramda_1.without(ramda_1.toString(ramda_1.last(val)))(old_index);\n    var key_to_update = exports.path_to_key(ramda_1.dropLast(1, val));\n\n    var update_obj = __assign(__assign({}, acc), (_a = {}, _a[key_to_update] = new_index, _a));\n\n    return update_obj;\n  }, data, missing_paths);\n  return output;\n};\n\nvar parent_keys = function (shpath) {\n  return shpath.length > 0 && !ramda_1.equals(shpath, ['']) ? shpath.map(function (el, i) {\n    var _a;\n\n    return _a = {}, _a[exports.path_to_key(ramda_1.slice(0, i, shpath))] = exports.key_to_path(shpath)[i], _a;\n  }) : [];\n};\n\nexports.get_required_indexes = function (key_list) {\n  var required_indexes = ramda_1.reduce(function (acc, val) {\n    var pkeys = ramda_1.compose(ramda_1.mergeAll, parent_keys, exports.key_to_path)(val);\n    var left = ramda_1.map(ensure_is_array)(acc);\n    var right = ramda_1.map(ensure_is_array)(pkeys);\n    return ramda_1.mergeWithKey(function (k, l, r) {\n      return exports.concat_if_nonexistent(l, r);\n    })(left, right);\n  }, {})(key_list);\n\n  var indexes_to_add_for_given_key = function (key, required_indexes, key_list) {\n    return ramda_1.mergeAll(required_indexes[key].map(function (el) {\n      var _a;\n\n      return _a = {}, _a[el] = ramda_1.includes(exports.concat_with_dot(key, el), key_list) ? 'leaf' : 'branch', _a;\n    }));\n  };\n\n  var commands = ramda_1.map(function (key) {\n    return ['hmset', key, indexes_to_add_for_given_key(key, required_indexes, key_list)];\n  })(ramda_1.keys(required_indexes));\n  return commands;\n};","map":{"version":3,"sources":["C:/Users/gamem/codecademy/node_modules/redibase/build/pure.js"],"names":["__assign","Object","assign","t","s","i","n","arguments","length","p","prototype","hasOwnProperty","call","apply","__spreadArrays","il","r","Array","k","a","j","jl","defineProperty","exports","value","ramda_1","require","serialize","is_array","el","type","is_object","is_array_or_object","ensure_is_array","is_numeric_string","test","path_to_key","path","join","key_to_path","compose","map","Number","split","stringify","ignoreFunction","parse","serializedJavascript","eval","concat_if_nonexistent","arr1","arr2","uniq","concat_with_dot","curry","b","reject","isEmpty","json_to_path_list","val","child_paths","unnest","child","chain","key","keys","who_cares","changes","subscriptions","reduce","acc","changed_key","new_pairs","new","old_pairs","old","relevant_subscription_keys","filter","startsWith","concat","watched_key","fns","values","strict_path_or","default_val","val_path","obj","hasPath","json_to_pairs","json","path_list","_a","redis_key","given_value","undefined","redis_value","pairs_to_json","pairs","output","paths","path_el","assocPath","map_keys","fn","fromPairs","adjust","toPairs","delete_parent_indices","missing_paths","data","old_index","dropLast","isNil","new_index","without","toString","last","key_to_update","update_obj","parent_keys","shpath","equals","slice","get_required_indexes","key_list","required_indexes","pkeys","mergeAll","left","right","mergeWithKey","l","indexes_to_add_for_given_key","includes","commands"],"mappings":"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","sourcesContent":["\"use strict\";\r\nvar __assign = (this && this.__assign) || function () {\r\n    __assign = Object.assign || function(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\r\n                t[p] = s[p];\r\n        }\r\n        return t;\r\n    };\r\n    return __assign.apply(this, arguments);\r\n};\r\nvar __spreadArrays = (this && this.__spreadArrays) || function () {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar ramda_1 = require(\"ramda\");\r\nvar serialize = require('serialize-javascript');\r\nexports.is_array = function (el) { return ramda_1.type(el) === 'Array'; };\r\nexports.is_object = function (el) { return ramda_1.type(el) === 'Object'; };\r\nexports.is_array_or_object = function (el) { return ramda_1.type(el) === 'Array' || ramda_1.type(el) === 'Object'; };\r\nvar ensure_is_array = function (value) { return exports.is_array(value) ? value : [value]; };\r\nexports.is_numeric_string = ramda_1.test(/^0$|^[1-9][0-9]*$/);\r\nexports.path_to_key = function (path) { return ramda_1.type(path) === \"Array\" ? path.join('.') : path; };\r\nexports.key_to_path = function (path) { return ramda_1.type(path) === \"String\" ? ramda_1.compose(ramda_1.map(function (el) { return exports.is_numeric_string(el) ? Number(el) : el; }), ramda_1.split('.'))(path) : path; };\r\nexports.stringify = function (value) { return serialize(value, { ignoreFunction: true }); };\r\nexports.parse = function (serializedJavascript) { return eval('(' + serializedJavascript + ')'); };\r\nexports.concat_if_nonexistent = function (arr1, arr2) { return ramda_1.uniq(__spreadArrays(arr1, arr2)); };\r\nexports.concat_with_dot = ramda_1.curry(function (a, b) { return ramda_1.compose(ramda_1.join('.'), ramda_1.reject(ramda_1.isEmpty))([a, b]); });\r\nvar json_to_path_list = function (val) {\r\n    if (exports.is_array(val)) {\r\n        var child_paths = ramda_1.unnest(val.map(function (child, i) {\r\n            return json_to_path_list(child).map(function (path) { return __spreadArrays([i], path); });\r\n        }));\r\n        return child_paths;\r\n    }\r\n    if (exports.is_object(val)) {\r\n        var child_paths = ramda_1.chain(function (key, i) {\r\n            return json_to_path_list(val[key]).map(function (path) { return __spreadArrays([key], path); });\r\n        })(ramda_1.keys(val));\r\n        return child_paths;\r\n    }\r\n    return [[]];\r\n};\r\nexports.who_cares = function (changes, subscriptions) {\r\n    return ramda_1.reduce(function (acc, val) {\r\n        var changed_key = val;\r\n        var new_pairs = changes.new[changed_key];\r\n        var old_pairs = changes.old[changed_key];\r\n        var relevant_subscription_keys = ramda_1.keys(subscriptions).filter(function (key) { return ramda_1.startsWith(key)(changed_key); });\r\n        return ramda_1.concat(relevant_subscription_keys.map(function (watched_key) {\r\n            var fns = ramda_1.values(subscriptions[watched_key]);\r\n            return { watched_key: watched_key, changed_key: changed_key, new: new_pairs, old: old_pairs, fns: fns };\r\n        }), acc);\r\n    }, [])(ramda_1.keys(__assign(__assign({}, changes.old), changes.new)));\r\n};\r\n// like pathOr but doesnt return null when value is null and not undefined\r\nexports.strict_path_or = function (default_val, val_path, obj) {\r\n    if (val_path.length === 0) {\r\n        return obj;\r\n    }\r\n    if (ramda_1.hasPath(val_path, obj)) {\r\n        return ramda_1.path(val_path, obj);\r\n    }\r\n    else {\r\n        return default_val;\r\n    }\r\n};\r\nexports.json_to_pairs = function (json) {\r\n    var path_list = json_to_path_list(json);\r\n    return ramda_1.reduce(function (acc, val) {\r\n        var _a;\r\n        var redis_key = exports.path_to_key(val);\r\n        var given_value = exports.strict_path_or(undefined, val, json);\r\n        var redis_value = exports.is_array_or_object(given_value) ? ramda_1.keys(given_value) : given_value;\r\n        return __assign(__assign({}, acc), (_a = {}, _a[redis_key] = redis_value, _a));\r\n    }, {})(path_list);\r\n};\r\nexports.pairs_to_json = function (pairs) {\r\n    var output = {};\r\n    var paths = ramda_1.compose(ramda_1.map(function (key) { return ({ path: exports.key_to_path(key), val: pairs[key] }); }), ramda_1.keys)(pairs);\r\n    paths.map(function (path_el) { return output = ramda_1.assocPath(path_el.path, path_el.val, output); });\r\n    return output;\r\n};\r\nexports.map_keys = ramda_1.curry(function (fn, obj) { return ramda_1.fromPairs(ramda_1.map(ramda_1.adjust(0, fn), ramda_1.toPairs(obj))); });\r\nexports.delete_parent_indices = function (missing_paths, data) {\r\n    var output = ramda_1.reduce(function (acc, val) {\r\n        var _a;\r\n        var old_index = acc[exports.path_to_key(ramda_1.dropLast(1, val))];\r\n        if (ramda_1.isNil(old_index))\r\n            return acc;\r\n        var new_index = ramda_1.without(ramda_1.toString(ramda_1.last(val)))(old_index);\r\n        var key_to_update = exports.path_to_key(ramda_1.dropLast(1, val));\r\n        var update_obj = __assign(__assign({}, acc), (_a = {}, _a[key_to_update] = new_index, _a));\r\n        return update_obj;\r\n    }, data, missing_paths);\r\n    return output;\r\n};\r\nvar parent_keys = function (shpath) { return shpath.length > 0 && !ramda_1.equals(shpath, ['']) ? shpath.map(function (el, i) {\r\n    var _a;\r\n    return (_a = {}, _a[exports.path_to_key(ramda_1.slice(0, i, shpath))] = exports.key_to_path(shpath)[i], _a);\r\n}) : []; };\r\nexports.get_required_indexes = function (key_list) {\r\n    var required_indexes = ramda_1.reduce(function (acc, val) {\r\n        var pkeys = ramda_1.compose(ramda_1.mergeAll, parent_keys, exports.key_to_path)(val);\r\n        var left = ramda_1.map(ensure_is_array)(acc);\r\n        var right = ramda_1.map(ensure_is_array)(pkeys);\r\n        return ramda_1.mergeWithKey(function (k, l, r) { return exports.concat_if_nonexistent(l, r); })(left, right);\r\n    }, {})(key_list);\r\n    var indexes_to_add_for_given_key = function (key, required_indexes, key_list) {\r\n        return ramda_1.mergeAll(required_indexes[key].map(function (el) {\r\n            var _a;\r\n            return (_a = {}, _a[el] = ramda_1.includes(exports.concat_with_dot(key, el), key_list) ? 'leaf' : 'branch', _a);\r\n        }));\r\n    };\r\n    var commands = ramda_1.map(function (key) { return ['hmset', key, indexes_to_add_for_given_key(key, required_indexes, key_list)]; })(ramda_1.keys(required_indexes));\r\n    return commands;\r\n};\r\n"]},"metadata":{},"sourceType":"script"}